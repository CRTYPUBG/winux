# ============================================================================
# WINUX Secure Release Pipeline
# ============================================================================
# 
# This workflow provides:
# - Deterministic, reproducible Go builds
# - SHA256 integrity verification
# - Signed GitHub Releases
# - Enterprise-grade supply chain security
#
# Triggers on semantic version tags: v*.*.*
# ============================================================================

name: WINUX Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  GO_VERSION: "1.22"
  BINARY_NAME: winux

jobs:
  # ==========================================================================
  # JOB 1: Build WINUX Binary
  # ==========================================================================
  build:
    name: Build WINUX
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.hash.outputs.sha256 }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building WINUX $VERSION"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Verify Go installation
        run: go version

      - name: Download dependencies
        run: go mod download

      - name: Build WINUX (Windows amd64)
        run: |
          VERSION_NUM=$(echo "${{ steps.version.outputs.version }}" | sed 's/^v//')
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 \
          go build \
            -trimpath \
            -ldflags="-s -w -X main.Version=${VERSION_NUM} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X github.com/CRTYPUBG/winux/internal/core.Version=${VERSION_NUM}" \
            -o ${{ env.BINARY_NAME }}.exe \
            ./cmd/winux

      - name: Build Update utility
        run: |
          VERSION_NUM=$(echo "${{ steps.version.outputs.version }}" | sed 's/^v//')
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 \
          go build \
            -trimpath \
            -ldflags="-s -w -X main.CurrentVersion=${VERSION_NUM} -X github.com/CRTYPUBG/winux/internal/updater.CurrentVersion=${VERSION_NUM}" \
            -o update.exe \
            ./cmd/update

      - name: Generate SHA256 checksums
        id: hash
        run: |
          sha256sum ${{ env.BINARY_NAME }}.exe > ${{ env.BINARY_NAME }}.exe.sha256
          sha256sum update.exe > update.exe.sha256
          SHA256=$(sha256sum ${{ env.BINARY_NAME }}.exe | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Verify binaries exist
        run: |
          ls -la *.exe
          file *.exe

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: winux-binaries-${{ steps.version.outputs.version }}
          path: |
            ${{ env.BINARY_NAME }}.exe
            ${{ env.BINARY_NAME }}.exe.sha256
            update.exe
            update.exe.sha256
          retention-days: 30
          if-no-files-found: error

  # ==========================================================================
  # JOB 2: Create GitHub Release
  # ==========================================================================
  release:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: winux-binaries-${{ needs.build.outputs.version }}
          path: ./release

      - name: List release artifacts
        run: ls -la ./release/

      - name: Generate release notes
        run: |
          VERSION=${{ needs.build.outputs.version }}
          cat << 'EOF' > release-notes.md
          # WINUX $VERSION
          
          Native Linux-like command-line utilities for Windows.
          
          ## ðŸ“¦ Downloads
          
          | File | Description |
          |------|-------------|
          | `winux.exe` | Main binary (ls, cat, grep, rm, mkdir, touch, pwd, echo) |
          | `update.exe` | Self-update utility |
          | `*.sha256` | SHA256 checksums |
          
          ## âœ… Verification
          
          ```powershell
          # Verify SHA256
          (Get-FileHash winux.exe -Algorithm SHA256).Hash
          ```
          
          ## ðŸš€ Quick Install
          
          ```powershell
          # Download
          Invoke-WebRequest -Uri "https://github.com/CRTYPUBG/winux/releases/latest/download/winux.exe" -OutFile winux.exe
          
          # Add to PATH (run as admin)
          Move-Item winux.exe "C:\Windows\System32\"
          ```
          
          ## ðŸ“‹ Available Commands
          
          - `ls` - List directory contents
          - `cat` - Print file contents
          - `grep` - Search patterns in files
          - `rm` - Remove files/directories
          - `mkdir` - Create directories
          - `touch` - Create files / update timestamps
          - `pwd` - Print working directory
          - `echo` - Display text
          
          ---
          
          **Full changelog:** https://github.com/CRTYPUBG/winux/blob/main/CHANGELOG.md
          EOF
          sed -i "s/\$VERSION/$VERSION/g" release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: WINUX ${{ needs.build.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(needs.build.outputs.version, '-') }}
          files: |
            ./release/winux.exe
            ./release/winux.exe.sha256
            ./release/update.exe
            ./release/update.exe.sha256
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # JOB 3: Post-Release Summary
  # ==========================================================================
  notify:
    name: Release Summary
    needs: [build, release]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Print summary
        run: |
          echo "ðŸŽ‰ WINUX ${{ needs.build.outputs.version }} released!"
          echo "ðŸ“¦ SHA256: ${{ needs.build.outputs.sha256 }}"
          echo "ðŸ”— https://github.com/CRTYPUBG/winux/releases/tag/${{ needs.build.outputs.version }}"
