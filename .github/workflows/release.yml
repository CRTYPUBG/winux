# ============================================================================
# WINUX Secure Release Pipeline (SLSA Level 3)
# ============================================================================
# 
# This workflow provides:
# - Deterministic, reproducible Go builds
# - SLSA Level 3 provenance attestation
# - SHA256 integrity verification
# - Signed GitHub Releases
# - Enterprise-grade supply chain security
#
# Triggers on semantic version tags: v*.*.*
# ============================================================================

name: WINUX Secure Release (SLSA3)

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  id-token: write
  actions: read

env:
  GO_VERSION: "1.22"
  BINARY_NAME: winux
  GOOS: windows
  GOARCH: amd64

jobs:
  # ==========================================================================
  # JOB 1: Build WINUX Binary
  # ==========================================================================
  build:
    name: Build WINUX (Go Static)
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      sha256: ${{ steps.hash.outputs.sha256 }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building WINUX $VERSION"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Verify Go installation
        run: go version

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...
        continue-on-error: true

      - name: Build WINUX (static, stripped, hardened)
        run: |
          CGO_ENABLED=0 GOOS=${{ env.GOOS }} GOARCH=${{ env.GOARCH }} \
          go build \
            -trimpath \
            -ldflags="-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o ${{ env.BINARY_NAME }}.exe \
            ./cmd/winux

      - name: Generate SHA256 checksum
        id: hash
        run: |
          SHA256=$(sha256sum ${{ env.BINARY_NAME }}.exe | awk '{print $1}')
          echo "$SHA256  ${{ env.BINARY_NAME }}.exe" > ${{ env.BINARY_NAME }}.exe.sha256
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Verify binary exists
        run: |
          ls -la ${{ env.BINARY_NAME }}.exe
          file ${{ env.BINARY_NAME }}.exe

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: winux-build-${{ steps.version.outputs.version }}
          path: |
            ${{ env.BINARY_NAME }}.exe
            ${{ env.BINARY_NAME }}.exe.sha256
          retention-days: 30
          if-no-files-found: error

  # ==========================================================================
  # JOB 2: Generate SLSA Level 3 Provenance
  # ==========================================================================
  provenance:
    name: Generate SLSA3 Provenance
    needs: build
    permissions:
      actions: read
      id-token: write
      contents: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_generic_slsa3.yml@v1.10.0
    with:
      base64-subjects: |
        ${{ needs.build.outputs.sha256 }}  winux.exe
      upload-assets: false

  # ==========================================================================
  # JOB 3: Create GitHub Release
  # ==========================================================================
  release:
    name: Publish GitHub Release
    needs: [build, provenance]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source (for changelog)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: winux-build-${{ needs.build.outputs.version }}
          path: ./release

      - name: Download SLSA provenance
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.provenance.outputs.provenance-name }}
          path: ./release
        continue-on-error: true

      - name: List release artifacts
        run: ls -la ./release/

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ needs.build.outputs.version }}
          cat << EOF > release-notes.md
          # WINUX $VERSION
          
          ## Downloads
          
          | File | Description |
          |------|-------------|
          | \`winux.exe\` | Windows x64 binary |
          | \`winux.exe.sha256\` | SHA256 checksum |
          | \`*.intoto.jsonl\` | SLSA3 provenance attestation |
          
          ## Verification
          
          \`\`\`powershell
          # Verify SHA256
          (Get-FileHash winux.exe -Algorithm SHA256).Hash
          # Expected: ${{ needs.build.outputs.sha256 }}
          \`\`\`
          
          ## Installation
          
          \`\`\`powershell
          # Download and add to PATH
          Invoke-WebRequest -Uri "https://github.com/CRTYPUBG/winux/releases/download/$VERSION/winux.exe" -OutFile winux.exe
          
          # Or use winget (when available)
          winget install CRTYPUBG.WINUX
          \`\`\`
          
          ## Security
          
          - âœ… SLSA Level 3 provenance
          - âœ… SHA256 verified
          - âœ… Reproducible build
          - âœ… Supply chain secured
          
          ---
          
          Full changelog: https://github.com/CRTYPUBG/winux/compare/...${VERSION}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: WINUX ${{ needs.build.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(needs.build.outputs.version, '-') }}
          files: |
            ./release/winux.exe
            ./release/winux.exe.sha256
            ./release/*.intoto.jsonl
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # JOB 4: Update Package Managers (Optional)
  # ==========================================================================
  notify:
    name: Post-Release Notifications
    needs: [build, release]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Release summary
        run: |
          echo "ðŸŽ‰ WINUX ${{ needs.build.outputs.version }} released successfully!"
          echo "ðŸ“¦ SHA256: ${{ needs.build.outputs.sha256 }}"
          echo "ðŸ”— https://github.com/CRTYPUBG/winux/releases/tag/${{ needs.build.outputs.version }}"
